---
layout: page
title: Building a Flexible Water Model
subtitle: using Genetic Algorithms
cover-img: /assets/img/building-water-model/water_header.png
thumbnail-img: /assets/img/building-water-model/water_thumbnail.png
share-img: /assets/img/building-water-model/water_thumbnail.png
gh-repo: evenmn/evenmn.github.io
gh-badge: [follow]
tags: [dissociative, water, molecular dynamics, Vashishta, genetic algorithm]
comments: true
mathjax: true
author: Even Nordhagen
---

Computer experiments offer information that is not available in real experiments, at the same time as they are less error prone and often cheaper. This is the main reason why ever more research is based on computer simulations. However, can we really rely on computer simulations when making important decision? How do we know that the computer experiments capture effects as the real experiments? The answer is that the simulations have to be tested and verified on the exact thing that we aim to investigate, as computer simulations will never capture all aspects of the real world. 

This blog post will be about computer simulations of water: A highly important, yet highly complex substance to model. When looking at real systems, it is hard to ignore water. Water is the most common liquid on Earth, and is found in most geological, biological and (fill in) environments. At the same time, water features some really strange features like (fill in). making it difficult to model. 

![Water molecule](/assets/img/building-water-model/water_illustration.jpg){: .mx-auto.d-block :}
*Water is a highly complex substance. Generated by Stable Diffusion.*

To overcome these challenges, the most common water models are rigid, meaning that the distance between the oxygen and hydrogen atoms are kept fixed. This discards/supresses all the reactions, acidity and many other chemical processes that are crucial to realistically model a real system. To be able to model this, we need a dissociative water model. This is exactly what we are presenting [in our recent work](https://pubs.acs.org/doi/full/10.1021/acs.jpcb.4c06389), published in Journal of Physical Chemistry C.

Charles Darwin controversely presented his evolution theory 165 years ago, which hypothesed natural selection due to survival of the fittest. Even though the theory was debatted back then, it has became one of the fundaments of modern biology. In addition to exploitation component of natural selection, there is an exploration component driven by mutation and recombination. We have used all these concepts in a genetic algorithm used to optimize our water model.

![Water molecule](/assets/img/building-water-model/dissociative_water.png){: .mx-auto.d-block :}
*Real water molecules can react with the surroundings. Most water models do not capture this chemical nature of water.*

## Reactive water
A dissociative water model means that each water molecule is allowed to dissolve - meaning that water molecules can lose hydrogen atoms to the surroundings (form OH$$^-$$-groups) or take hydrogen atoms from the surroundings (form hydronium). The reaction can be described as

$$
\mathrm{H}_2\mathrm{O}\rightleftharpoons\mathrm{OH}^-+\mathrm{H}^+,
$$

or

$$
2\mathrm{H}_2\mathrm{O}\rightleftharpoons\mathrm{H}_3\mathrm{O}^+ + \mathrm{OH}^-.
$$

These reactions are among the main procedures in liquid water, and are crucial to include to model realistic water. For instance, acidity is measured by the pH-scale where the acidity is defined by the logarithm of the concentration of $$\mathrm{H}^+$$:

$$
\mathrm{pH} = -\log\left(\frac{N_{\mathrm{H}^+}}{N}\right),
$$

where $$N_{\mathrm{H}^+}$$ is the number of $$\mathrm{H}^+$$ ions and $$N$$ is the total number of molecules. In other words, $$N_{\mathrm{H}^+}/N$$ is just the concentration of hydrogen ions. A neutral pH-value is around 7, meaning that there is about one hydrogen ion per 10 million water molecules from the definition above. In contrast, an acid liquid of pH 4 will have one hydrogen ion per 10,000 molecules and so on. 

## An all-atom water model
So how can we incorporate this behavior of water into a water model? One solution is to let an atom detach from the molecule if the force exerted on the atom exceeds some threshold. However, this would create a binary dynamics of atom attachment - detachment, which in the end of the day is unphysical. A better solution is to stick to an all-atom model, which treats all atoms equally where a molecule is no concept. Atoms follow the same laws no matter if they are part of a molecule or free. This is how atoms behave in the nature.

![Water molecule](/assets/img/building-water-model/water_images-1.png){: .mx-auto.d-block :}

*The force acting on a particle $$i$$ is determined by the distance to its neighbor atoms, $$r_{ij}$$ and $$r_{ik}$$, and the angle between three atoms $$\theta_{jik}$$.*

We have relied on the so-called Vashishta model for interactions between atoms, manifesting that four forces act between two atoms:

- Charge-charge force (Coulomb), $$\propto 1/r^2$$
- Change-dipole force, $$\propto 1/r^5$$
- Dipole-dipole force (van der Waals force), $$\propto 1/r^7$$
- Repulsive force steming from the overlap of electron clouds, $$\propto ~1/r^{12}$$

Here $$r$$ is the distance between the two atoms. Note that all these forces are actually Coulombic forces, but since each atom is treated like a charged point particle, polarization of electrons is not possible.

The total two-atom potential is given by

$$
V_{ij}^{(2)}(r)=\frac{H_{ij}}{r^{\eta_{ij}}}+\frac{Z_iZ_j}{r}e^{-r/\lambda_1}-\frac{D_{ij}}{2r^4}e^{r/\lambda_4}-\frac{W_{ij}}{r^6},
$$

where $$H_{ij}$$, $$\eta_{ij}$$, $$Z_i$$, $$Z_j$$, $$\lambda_1$$, $$D_{ij}$$, $$\lambda_4$$ and $$W_{ij}$$ are water-specific parameters. The exact shape of the interaction is not the important here, the main take-away is that for each combination of atom types there are 8 parameters to be found.

There is an additional force acting when there are more than two atoms present. This is important to force an angle between three atoms, in particular important when modelling water. It works by introducing an angular spring term with some equilibrium angle:

$$
V_{jik}^{(3)}(r_{ij}, r_{ik}, \theta_{jik})=B_{jik}\exp\left(\frac{\gamma}{r_{ij}-r_0}+\frac{\gamma}{r_{ik}-r_0}\right)\frac{(\cos\theta_{jik}-\cos\bar{\theta}_{jik})^2}{1+C_{jik}(\cos\theta_{jik}-\cos\bar{\theta}_{jik})^2},
$$

where $$B_{jik}$$, $$\gamma$$, $$r_0$$, $$\cos\bar{\theta}_{jik}$$ and $$C_{jik}$$ are again parameters to be found. There is a last parameter, $$r_c$$, determining the cutoff distance, we do not care about interactions between atoms separated by a distance larger than this. Summing up, there are 14 parameters to be found for each possible three-atom combination. For water, with two atom types (hydrogen and oxygen), there are $$2^3=8$$ possible three-atom combinations, giving 112 parameters in total.

Some of these parameters are equal due to symmetries, while some of them can be deduced from physical experiments. Still, there are many parameters to be found, way more than possible with a simple grid search. We need a systematic way of doing this. 

![Genetic Algorithm](/assets/img/building-water-model/genetic_algorithm.png){: .mx-auto.d-block :}
*One generation of the genetic algorithm: We start from an initial population, here of 5 individuals. First, the fittest individuals are identified using an objective fitness score, and individuals that don't obey to the standard are discarded. Thereafter, crossover between their chromosomes (here respresented by colored boxes) is performed. This action represents the exploitation element of evolution. The exploration aspect of evolution is covered by random mutations of the chromosomes, which is the last thing that happens before the next population generation is created*

## Global optimization using a genetic algorithm
Inspired by evolution, we use a genetic algorithm to find optimal values for the parameters. According to Charles Darwin's evolutionary theory the biological evolution is controlled by natural selection: Only the strongest individuals will be able to reproduce, reinforcing the population for every generation. When two individuals mate, the genomes are mixed in an apparent random fashion, exploiting the knowledge about the genes. There is also an exploration aspect where cells mutate, meaning that some of the genes are changed independently of the parent genomes.

Genetic, or evolutionary, algorithms are heavily inspired by Darwin's evolutionary theory, where each individual represents a set of parameters instead of a set of genomes. Starting from a population of $$N$$ individuals, the fitness of each individual is calculated using an objective score. Only the fittest individuals are allowed to reproduce and thus the next generation of individuals is only a result of the fittest individuals of the previous generation. Some parameters are also randomly changed to represent cell mutation, letting the algorithm explore the parameter space better.

### Objective fitness score
The genetic algorithm relies heavily on an objective fitness function. Generally, it is just a skill score determining how good an individual performs. In our case, each individual is a parameterizartion of the Vashishta potential and the objective skill score is determined by how close each parameterization is the experimental values of bulk water density at various temperatures and pressures. Calculating the density requires molecular dynamics simulations, and is by far the most expensive part of the genetic algorithm.

Since we want to optimize multiple quantities simultaneously, the objective fitness function consists of several terms. The brute-force way of evaluating the function is to  weight all the terms equally and calculating everything in one go. However, we can actually save a lot of computations by prioritizing some of the quantities first, and gradually add quantities of lower priority when the higher priorities are satisfied. This is what is the key ingredients in the so-called Hierarchical Objective Genetic Algorithm (HOGA).

![Nelder-Mead](/assets/img/building-water-model/nelder-mead.png){: .mx-auto.d-block :}
*Nelder-Mead simplex algorithm*

## Local optimization
Once the fitness score is satisfyingly low, we have found a satisfactory local minimum in the parameter space. To dig deeper in this local minimum, we use a local optimization technique based on the Nelder-Mead simplex method. The idea is simple: We evaluate three points close to the best point that we have, hence the name simplex. Based on the results we move one of the points/vertices and create a new simplex based on four possible actions:

- reflect
- contract
- expand
- shrink

The action to perform is based on a set of rules, made to exploit the knowledge at the same time as we explore. The new simplex hopefully has a lower center than the previous one. We continue this procedure until convergence. 

![Siloxane bridges](/assets/img/building-water-model/siloxane_bridges.png){: .mx-auto.d-block :}
*With a reactive water potential we can simulate reactions with other components. Here, water is simulated together with silicon dioxide and is shown to form siloxane bonds (purple). Siloxane bonds are important in frictional aging as discussed in [my friction project](https://evenmn.github.io/projects/friction/).*

## Adding more components
So what if we want to simulate more than water?
Following the same procedure, we can add more components. However, every time we add a new component, interaction parameters between the existing components and the new component, as well as between the new component itself has to be found. For the third parameter, this corresponds to $$3^3-2^3=19$$ new three-atom combinations.

For every additional parameter to optimize, the optimization task gets exponentially harder. In general, it is therefore difficult to add more components to the parameter optimization. Fortunately, we can often use our physical intuition to reduce the dimensionality of the optimization problem and make it feasible. For instance, we know that water molecules have to be charge neutral, i.e. the charge of hydrogen ($$Z_{\mathrm{H}}$$) and oxygen ($$Z_{\mathrm{O}}$$) are related through the equation:

$$2Z_{\mathrm{H}}=-Z_{\mathrm{O}}.$$

For geological applications, the interplay between water and silicon dioxide, or silica, is especially interesting. To build a model for silica and water, we only need to addsilicon as an additional component to the water model. This can be done by following the optimization procedure above. 

## Conclusions
Computer simulations offer insights and provide information that is not available from real experiments. However, to get realistic results that we can rely on, the model explaining the atomic interactions has to be tuned correctly. In this project we have looked at how an reactive water model can be derived by an approach inspired by Darwin's evolutionary theory. The model can also be extended to more components.

For more details, please read our paper published in Journal of Physical Chemistry B: [Camposano, Nordhagen, Sveinsson, Malthe-Sørenssen, *Genetic Algorithm Workflow for Parameterization of a Water Model Using the Vashishta Force Field*, J. Phys. Chem. B (2025), **129**, 4, 1331–1342](https://pubs.acs.org/doi/full/10.1021/acs.jpcb.4c06389).

Disclaimer: All illustrations used here were generated with [Ovito](https://www.ovito.org) and TikZ.

Feel free to drop a comment or question below if you have thoughts or experiences you'd like to share.

![Signature](/assets/img/signature.png){: .mx-auto.d-block :}
